# å°ˆæ¡ˆèªªæ˜æ–‡ä»¶


`ta-lib-everywhere` (koreal6803) é€™å€‹å¥—ä»¶ä¸»è¦è§£æ±ºäº† TA-Lib åœ¨å®‰è£æ™‚éœ€è¦ç·¨è­¯ C èªè¨€åº•å±¤çš„éº»ç…©ï¼Œå®ƒæä¾›äº†é å…ˆç·¨è­¯å¥½çš„ Wheelsã€‚

**é‡é»æ˜¯ï¼šå®ƒçš„ç”¨æ³•å’Œæ¨™æº–çš„ TA-Lib å®Œå…¨ä¸€æ¨£ã€‚**

é€™æ„å‘³è‘—æˆ‘å€‘å®‰è£æ™‚ä½¿ç”¨ `pip install ta-lib-everywhere`ï¼Œä½†åœ¨ Python ç¨‹å¼ç¢¼ä¸­ä¾ç„¶æ˜¯ `import talib`ã€‚

ä»¥ä¸‹æ˜¯ç‚ºæ‚¨æ•´åˆäº† **UI Wireframe (é¸è‚¡ä»‹é¢)** + **TA-Lib MACD è¨ˆç®—** çš„å®Œæ•´ Dash æ‡‰ç”¨ç¨‹å¼ç¢¼ã€‚æ‚¨å¯ä»¥ç›´æ¥è¤‡è£½ä¸¦åŸ·è¡Œã€‚

### æ­¥é©Ÿ 1: å®‰è£å¥—ä»¶

è«‹åœ¨çµ‚ç«¯æ©Ÿ (Terminal) åŸ·è¡Œï¼š

```bash
pip install dash pandas dash-bootstrap-components ta-lib-everywhere

```

### æ­¥é©Ÿ 2: å®Œæ•´ç¨‹å¼ç¢¼ (`app.py`)

é€™ä»½ç¨‹å¼ç¢¼åŒ…å«äº†ï¼š

1. **è³‡æ–™è™•ç†å±¤**ï¼šæ•´åˆäº†æ‚¨çš„ `talib2df` å’Œ MACD è©•åˆ†é‚è¼¯ã€‚
2. **å‰ç«¯ä½ˆå±€**ï¼šå®Œå…¨ä¾ç…§æ‚¨ç¢ºèªçš„ Wireframe å¯¦ä½œ (å·¦å´å°èˆªã€ä¸­é–“è¼¸å…¥ã€ä¸‹æ–¹åœ–è¡¨)ã€‚
3. **äº’å‹•é‚è¼¯**ï¼šé»æ“Šã€Œé–‹å§‹è¨ˆç®—ã€æœƒè·‘ MACD è©•åˆ†ï¼›é»æ“Šã€Œè¡¨æ ¼æŸä¸€è¡Œã€æœƒæ›´æ–°ä¸‹æ–¹èµ°å‹¢åœ–ã€‚

```python
import dash
from dash import dcc, html, Input, Output, State, dash_table
import dash_bootstrap_components as dbc
import pandas as pd
import numpy as np
import talib
from talib import abstract

# ==========================================
# 1. æ¨¡æ“¬è³‡æ–™èˆ‡ TA-Lib æ•´åˆæ¨¡çµ„
# ==========================================

# æ¨¡æ“¬å°è‚¡å‡è³‡æ–™ç”Ÿæˆå™¨ (ç”¨ä¾†ä»£æ›¿çœŸå¯¦ API)
def get_mock_stock_data(stock_id, days=100):
    np.random.seed(int(stock_id) if stock_id.isdigit() else 0)
    dates = pd.date_range(end=pd.Timestamp.now(), periods=days)
    base_price = np.random.randint(100, 1000)
    
    # éš¨æ©Ÿæ¼«æ­¥ç”¢ç”Ÿåƒ¹æ ¼
    close = base_price + np.cumsum(np.random.randn(days) * 10)
    high = close + np.random.rand(days) * 5
    low = close - np.random.rand(days) * 5
    open_ = close + np.random.randn(days) * 2
    volume = np.random.randint(1000, 50000, size=days).astype(float)
    
    df = pd.DataFrame({
        'open': open_,
        'high': high,
        'low': low,
        'close': close,
        'volume': volume
    }, index=dates)
    return df

# --- æ‚¨çš„æ ¸å¿ƒå·¥å…·: TA-Lib è½‰æ›èˆ‡è¨ˆç®— ---

def talib2df(talib_output, df_index):
    """
    å°‡ TA-Lib è¼¸å‡ºè½‰ç‚º Pandas æ ¼å¼ï¼Œä¸¦å°é½Š Index
    """
    if isinstance(talib_output, list):
        ret = pd.DataFrame(talib_output).transpose()
    elif isinstance(talib_output, dict):
        ret = pd.DataFrame(talib_output)
    else:
        ret = pd.Series(talib_output)
    ret.index = df_index
    return ret

def calculate_macd_score(df):
    """
    è¨ˆç®— MACD æŒ‡æ¨™ä¸¦çµ¦äºˆè©•åˆ†
    """
    # 1. æº–å‚™ TA-Lib éœ€è¦çš„å°å¯«æ¬„ä½è¼¸å…¥
    inputs = {
        'open': df['open'], 'high': df['high'], 'low': df['low'],
        'close': df['close'], 'volume': df['volume']
    }
    
    # 2. å‘¼å« TA-Lib è¨ˆç®— MACD
    # abstract.MACD å›å‚³: macd, macdsignal, macdhist
    out = abstract.MACD(inputs)
    macd_df = talib2df(out, df.index)
    
    # 3. è©•åˆ†é‚è¼¯ (å–æœ€æ–°ä¸€å¤©)
    latest = macd_df.iloc[-1]
    prev = macd_df.iloc[-2]
    
    score = 60 # åŸºç¤åˆ†
    notes = []
    
    # åˆ¤æ–·é»ƒé‡‘äº¤å‰ (æŸ±ç‹€åœ–ç”±è² è½‰æ­£)
    if prev['macdhist'] < 0 and latest['macdhist'] > 0:
        score += 20
        notes.append("MACDé‡‘å‰")
    elif latest['macdhist'] > 0:
        score += 5 # å¤šé ­æ’åˆ—å¾®åŠ åˆ†
        
    # åˆ¤æ–·æ­»äº¡äº¤å‰
    if prev['macdhist'] > 0 and latest['macdhist'] < 0:
        score -= 20
        notes.append("MACDæ­»å‰")
        
    return score, " ".join(notes), macd_df

# ==========================================
# 2. Dash App åˆå§‹åŒ–
# ==========================================

app = dash.Dash(__name__, external_stylesheets=[dbc.themes.FLATLY])

# ==========================================
# 3. ä»‹é¢ä½ˆå±€ (ä¾ç…§ Wireframe)
# ==========================================

# å·¦å´å´é‚Šæ¬„
sidebar = html.Div(
    [
        html.H4("å°è‚¡æˆ°æƒ…å®¤ Pro", className="display-7"),
        html.Hr(),
        dbc.Nav(
            [
                dbc.NavLink("ğŸ”´ å³æ™‚æˆ°æƒ…å®¤", href="#", active=False),
                dbc.NavLink("ğŸ‘‰ é¸è‚¡è©•åˆ†ç³»çµ±", href="#", active=True),
                dbc.NavLink("âš™ï¸ ç³»çµ±è¨­å®š", href="#"),
            ],
            vertical=True,
            pills=True,
        ),
    ],
    style={
        "position": "fixed", "top": 0, "left": 0, "bottom": 0, "width": "16rem",
        "padding": "2rem 1rem", "backgroundColor": "#f8f9fa",
    },
)

# ä¸»å…§å®¹å€
content = html.Div(
    [
        html.H2("ğŸ“‹ æ¯æ—¥é¸è‚¡è©•åˆ†", className="mb-3"),
        html.P("è¼¸å…¥è§€å¯Ÿæ¸…å–®ï¼Œç³»çµ±å°‡ä¾æ“š MACD æŠ€è¡“é¢é€²è¡Œè©•åˆ†ã€‚"),
        
        # ä¸Šæ–¹ï¼šè¼¸å…¥å€å¡Š
        dbc.Card(
            dbc.CardBody([
                html.Label("è‚¡ç¥¨ä»£ç¢¼ (ä»¥é€—è™Ÿåˆ†éš”):"),
                dbc.Textarea(
                    id="input-stock-list",
                    placeholder="ä¾‹å¦‚: 2330, 2454, 3008, 2603...",
                    value="2330, 2454, 3008", # é è¨­å€¼
                    style={"height": "100px"}
                ),
                dbc.Button("ğŸš€ é–‹å§‹è¨ˆç®—è©•åˆ†", id="btn-calculate", color="primary", className="mt-3"),
                html.Span(id="status-msg", className="ms-3 text-success")
            ])
        , className="mb-4 shadow-sm"),
        
        html.Hr(),
        
        # ä¸­é–“ï¼šçµæœè¡¨æ ¼
        html.H4("è©•åˆ†çµæœ (é»æ“Šè¡Œå¯æŸ¥çœ‹èµ°å‹¢)", className="mb-3"),
        dash_table.DataTable(
            id='score-table',
            columns=[
                {"name": "ä»£ç¢¼", "id": "id"},
                {"name": "åç¨±", "id": "name"},
                {"name": "ç¸½åˆ†â­", "id": "score"},
                {"name": "æ”¶ç›¤åƒ¹", "id": "price"},
                {"name": "èªªæ˜", "id": "note"},
            ],
            data=[],
            row_selectable='single', # é–‹å•Ÿå–®é¸åŠŸèƒ½
            selected_rows=[0],       # é è¨­é¸ä¸­ç¬¬ä¸€è¡Œ
            style_cell={'textAlign': 'left'},
            style_header={'fontWeight': 'bold', 'backgroundColor': '#eeeeee'},
            # æ¢ä»¶æ ¼å¼ï¼šç¸½åˆ† > 70 è®Šç´…è‰²ç²—é«”
            style_data_conditional=[
                {
                    'if': {'filter_query': '{score} >= 70', 'column_id': 'score'},
                    'color': 'red', 'fontWeight': 'bold'
                }
            ]
        ),
        
        html.Hr(),
        
        # ä¸‹æ–¹ï¼šåœ–è¡¨å€
        html.H4("ğŸ“ˆ å€‹è‚¡å³æ™‚èµ°å‹¢", className="mt-4 mb-3"),
        dcc.Graph(id='stock-chart'),
        
        # éš±è—å€å¡Šï¼Œç”¨ä¾†æš«å­˜è¨ˆç®—å¥½çš„è©³ç´°æ•¸æ“š (ä»¥å…ç•«åœ–æ™‚è¦é‡ç®—)
        dcc.Store(id='store-calc-data') 
    ],
    style={"marginLeft": "18rem", "marginRight": "2rem", "padding": "2rem 1rem"},
)

app.layout = html.Div([sidebar, content])

# ==========================================
# 4. å›èª¿å‡½æ•¸ (Callbacks)
# ==========================================

# Callback 1: é»æ“ŠæŒ‰éˆ• -> è¨ˆç®—è©•åˆ† -> æ›´æ–°è¡¨æ ¼ èˆ‡ å„²å­˜æ•¸æ“š
@app.callback(
    [Output("score-table", "data"),
     Output("status-msg", "children"),
     Output("store-calc-data", "data")], # å°‡è©³ç´°æ•¸æ“šå­˜åˆ°ç€è¦½å™¨
    Input("btn-calculate", "n_clicks"),
    State("input-stock-list", "value"),
    prevent_initial_call=False
)
def update_table(n_clicks, input_str):
    if not input_str:
        return [], "è«‹è¼¸å…¥ä»£ç¢¼", {}
    
    stock_ids = [s.strip() for s in input_str.split(',') if s.strip()]
    table_data = []
    full_data_store = {} #ç”¨ä¾†å­˜æ¯å€‹è‚¡ç¥¨çš„è©³ç´° MACD æ•¸æ“š
    
    # å‡è£æœ‰ä¸€å€‹ä»£ç¢¼å°ç…§è¡¨
    name_map = {"2330":"å°ç©é›»", "2454":"è¯ç™¼ç§‘", "3008":"å¤§ç«‹å…‰", "2603":"é•·æ¦®"}
    
    for sid in stock_ids:
        # 1. å–å¾—è³‡æ–™
        df = get_mock_stock_data(sid)
        
        # 2. è¨ˆç®— MACD èˆ‡ è©•åˆ†
        score, note, macd_df = calculate_macd_score(df)
        
        # 3. æº–å‚™è¡¨æ ¼è³‡æ–™
        table_data.append({
            "id": sid,
            "name": name_map.get(sid, "æœªçŸ¥å€‹è‚¡"),
            "score": score,
            "price": round(df['close'].iloc[-1], 2),
            "note": note
        })
        
        # 4. æº–å‚™ç¹ªåœ–è³‡æ–™ (åºåˆ—åŒ–ç‚º JSON å‹å–„æ ¼å¼)
        # æˆ‘å€‘æŠŠåƒ¹æ ¼å’Œ MACD æ•¸å€¼éƒ½å­˜èµ·ä¾†
        full_data_store[sid] = {
            "date": df.index.strftime('%Y-%m-%d').tolist(),
            "close": df['close'].tolist(),
            "macd": macd_df['macd'].fillna(0).tolist(),
            "signal": macd_df['macdsignal'].fillna(0).tolist(),
            "hist": macd_df['macdhist'].fillna(0).tolist()
        }
    
    # ä¾ç…§åˆ†æ•¸æ’åº
    table_data.sort(key=lambda x: x['score'], reverse=True)
    
    msg = f"âœ… è¨ˆç®—å®Œæˆ! å…± {len(stock_ids)} æª”ã€‚"
    return table_data, msg, full_data_store

# Callback 2: é»æ“Šè¡¨æ ¼ -> æ›´æ–°ä¸‹æ–¹åœ–è¡¨
@app.callback(
    Output("stock-chart", "figure"),
    Input("score-table", "selected_rows"), # ç›£è½é¸æ“‡çš„è¡Œç´¢å¼•
    State("score-table", "data"),          # å–å¾—ç›®å‰è¡¨æ ¼è³‡æ–™
    State("store-calc-data", "data")       # å–å¾—æš«å­˜çš„è©³ç´°æ•¸æ“š
)
def update_chart(selected_rows, table_data, full_data):
    if not selected_rows or not table_data or not full_data:
        return {}
    
    # å–å¾—é¸ä¸­çš„è‚¡ç¥¨ä»£ç¢¼
    row_idx = selected_rows[0]
    stock_id = table_data[row_idx]['id']
    stock_name = table_data[row_idx]['name']
    
    # å¾ Store ä¸­å–å‡ºæ•¸æ“š
    data = full_data.get(stock_id)
    if not data:
        return {}
        
    # ç¹ªåœ– (ä½¿ç”¨ Plotly Graph Objects ä»¥ç²å¾—æœ€å¤§éˆæ´»æ€§)
    from plotly.subplots import make_subplots
    import plotly.graph_objects as go
    
    # å»ºç«‹é›™è»¸åœ–è¡¨ (ä¸Šåœ–åƒ¹æ ¼, ä¸‹åœ– MACD)
    fig = make_subplots(rows=2, cols=1, shared_xaxes=True, 
                        vertical_spacing=0.03, row_heights=[0.7, 0.3])

    # ä¸Šåœ–: Kç·š (é€™è£¡ç°¡åŒ–ç”¨ Line ä»£æ›¿ï¼Œæ‚¨å¯ä»¥æ›æˆ Candlestick)
    fig.add_trace(go.Scatter(x=data['date'], y=data['close'], name="æ”¶ç›¤åƒ¹"), row=1, col=1)
    
    # ä¸‹åœ–: MACD
    fig.add_trace(go.Scatter(x=data['date'], y=data['macd'], name="DIF", line=dict(color='orange')), row=2, col=1)
    fig.add_trace(go.Scatter(x=data['date'], y=data['signal'], name="DEA", line=dict(color='blue')), row=2, col=1)
    fig.add_trace(go.Bar(x=data['date'], y=data['hist'], name="MACDæŸ±", marker_color='gray'), row=2, col=1)

    fig.update_layout(
        title=f"{stock_id} {stock_name} - MACD èµ°å‹¢åˆ†æ",
        height=500,
        margin=dict(l=20, r=20, t=50, b=20),
        hovermode="x unified"
    )
    
    return fig

if __name__ == "__main__":
    app.run_server(debug=True)

```

### ç¨‹å¼é‡é»èªªæ˜ï¼š

1. **MACD æ•´åˆ (`calculate_macd_score`)**ï¼š
* é€™éƒ¨åˆ†åˆ©ç”¨äº†æ‚¨æåˆ°çš„ `talib2df` æ¦‚å¿µã€‚
* `abstract.MACD(inputs)` æœƒè‡ªå‹•è¨ˆç®— DIF, DEA, Histogramã€‚
* æˆ‘åŠ å…¥äº†ä¸€å€‹ç°¡å–®çš„è©•åˆ†é‚è¼¯ï¼šè‹¥ **MACD é»ƒé‡‘äº¤å‰ (æ˜¨å¤©è² ã€ä»Šå¤©æ­£)**ï¼Œç¸½åˆ† +20 åˆ†ã€‚


2. **UI é€£å‹• (`dcc.Store`)**ï¼š
* é€™æ˜¯ä¸€å€‹é€²éšæŠ€å·§ã€‚ç•¶æˆ‘å€‘æŒ‰ã€Œè¨ˆç®—ã€æ™‚ï¼Œä¸åªæ›´æ–°è¡¨æ ¼ï¼Œé‚„æŠŠç®—å¥½çš„è©³ç´°æ•¸æ“šå­˜å…¥ç€è¦½å™¨çš„ `dcc.Store`ã€‚
* é€™æ¨£ç•¶æ‚¨é»æ“Šè¡¨æ ¼åˆ‡æ›è‚¡ç¥¨æ™‚ï¼Œä¸ç”¨é‡æ–°å‘¼å«å¾Œç«¯è¨ˆç®—ï¼Œç›´æ¥å¾ç€è¦½å™¨æš«å­˜æŠ“è³‡æ–™ç•«åœ–ï¼Œ**é€Ÿåº¦æœƒéå¸¸å¿«**ï¼Œå°±åƒä¸€èˆ¬çœ‹ç›¤è»Ÿé«”ä¸€æ¨£ã€‚


3. **Dash Table**:
* è¨­å®šäº† `row_selectable='single'`ï¼Œè®“æ‚¨å¯ä»¥é»æ“Šè¡¨æ ¼çš„ä¸€è¡Œã€‚
* è¨­å®šäº† `style_data_conditional`ï¼Œè®“åˆ†æ•¸ > 70 çš„è‚¡ç¥¨è‡ªå‹•è®Šç´…è‰²ï¼Œç¬¦åˆæ‚¨çš„è¦–è¦ºåŒ–éœ€æ±‚ã€‚